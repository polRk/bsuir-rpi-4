var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,n=(t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r,l=(e,t)=>{for(var s in t||(t={}))a.call(t,s)&&n(e,s,t[s]);if(r)for(var s of r(t))i.call(t,s)&&n(e,s,t[s]);return e},c=(e,r)=>t(e,s(r));class o extends class{constructor(e){this.apiKey=e,this.perPage=40,this.baseURL="https://newsapi.org"}getSources(e){const t=new URLSearchParams(c(l({},e),{apiKey:this.apiKey})),s=`${this.baseURL}/v2/sources?${t}`;return fetch(s).then((e=>e.json()))}getArticles(e){const t=new URLSearchParams(c(l({},e),{apiKey:this.apiKey})),s=`${this.baseURL}/v2/everything?${t}`;return fetch(s).then((e=>e.json()))}}{constructor(e){super(e),this.apiKey=e}static writeToCache(e,t){const s=JSON.stringify({updatedAt:new Date,result:t});localStorage.setItem(e,s),setTimeout((()=>localStorage.removeItem(e)),3e5)}static getFromCache(e){const t=JSON.parse(localStorage.getItem(e)||"null");return!t||(new Date).getTime()-new Date(t.updatedAt).getTime()>3e5?null:t.result}async getSources(e){const t=navigator.language.slice(0,2),s=new URLSearchParams(l({language:t},e)),r=`${this.baseURL}/v2/sources?${s}`,a=o.getFromCache(r);return a||super.getSources(l({language:t},e)).then((e=>("ok"===e.status&&o.writeToCache(r,e),e)))}async getArticles(e){const t=l({page:1,pageSize:40},e),{page:s,pageSize:n}=t,c=((e,t)=>{var s={};for(var n in e)a.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&r)for(var n of r(e))t.indexOf(n)<0&&i.call(e,n)&&(s[n]=e[n]);return s})(t,["page","pageSize"]),h=l({page:`${s}`,pageSize:`${n}`},c),u=new URLSearchParams(h),g=`${this.baseURL}/v2/everything?${u}`,d=o.getFromCache(g);return d||super.getArticles(h).then((e=>("ok"===e.status&&o.writeToCache(g,e),e)))}}class h{constructor(){this.listeners=[]}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter((t=>t!==e))}}notify(){this.listeners.forEach((e=>e()))}}var u,g;(g=u||(u={}))[g.AFTER_BEGIN=0]="AFTER_BEGIN",g[g.BEFORE_END=1]="BEFORE_END";class d{static render(e,t,s){switch(s){case 0:e.prepend(t);break;case 1:e.append(t)}}static createElement(e){const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}static replace(e,t){const s=t.parentElement;null==s||s.replaceChild(e,t)}static remove(e){e.getElement().remove(),e.removeElement()}}class m{constructor(){this.element=null}getElement(){return this.element||(this.element=d.createElement(this.getTemplate())),this.element}removeElement(){this.element=null}}class p extends m{constructor(e){super(),this.article=e}getTemplate(){const e=new URL(this.article.url);return`\n<li>\n  <a href="${this.article.url}" target="_blank" class="text-blue-700"><h2 class="text-lg font-bold">${this.article.title}</h2></a>\n\n  <a href="${this.article.url}" class="flex gap-1 items-center">\n    <img src="https://s2.googleusercontent.com/s2/favicons?domain=${e.hostname}" alt="favicon">\n    <span class="flex-1 text-green-700 font-bold clip">${e.hostname}<span class="font-medium">${e.pathname}</span></span>\n    <span class="text-gray-500">${new Date(this.article.publishedAt).toLocaleString()}</span>\n  </a>\n  <p>${this.article.description}</p>\n</li>`}}class f extends m{constructor(e){super(),this.language=e}getTemplate(){return`<option name="language" value="${this.language}" class="capitalize">${this.language}</option>`}}class w extends m{constructor(e){super(),this.search=e}getTemplate(){return`<input id="search__control" type="search" placeholder="Search ..." value="${this.search}"/>`}}class E extends m{constructor(e){super(),this.source=e}getTemplate(){const{id:e,name:t}=this.source;return`<option value="${e}">${t}</option>`}}const b=new o("fbc8b382ffde4f5594a85c06379e62b6"),v=new class extends h{constructor(){super(...arguments),this._search=""}get search(){return this._search}set search(e){this._search=e,this.notify()}},_=new class extends h{constructor(){super(...arguments),this._language=navigator.language.slice(0,2),this._languages=["ar","de","en","es","fr","he","it","nl","no","pt","ru","se","ud","zh"]}get language(){return this._language}get languages(){return this._languages}set language(e){this._language=e,this.notify()}},S=new class extends h{constructor(e){super(),this.apiClient=e,this._articles=[],this._totalResults=0}get articles(){return this._articles}get totalResults(){return this._totalResults}async fetchArticles(e){const{search:t,language:s,sources:r}=l({},e),a=await this.apiClient.getArticles({q:t,language:s,sources:r});return"error"===a.status?(alert(a.message),[]):(this._totalResults=a.totalResults,this._articles=a.articles,this.notify(),a.articles)}async fetchMoreArticles(e){const{search:t,language:s,sources:r}=l({},e),a=Math.floor(this._articles.length/this.apiClient.perPage)+1,i=await this.apiClient.getArticles({q:t,language:s,sources:r,page:a});return"error"===i.status?(alert(i.message),[]):(this._articles.push(...i.articles),this.notify(),i.articles)}}(b),x=new class extends h{constructor(e){super(),this.apiClient=e,this._sources=[],this._selected=[]}get sources(){return this._sources}get selected(){return this._selected}set selected(e){this._selected=e,this.notify()}async fetchSources(e){const t=await this.apiClient.getSources(e);if("error"===t.status)return alert(t.message),[];this._sources=t.sources;const s=this._sources[0];return s&&(this._selected=[s]),this.notify(),this._sources}}(b),y=(new class extends m{getTemplate(){return'<div id="news"></div>'}}).getElement(),O=(new class extends m{getTemplate(){return'<div id="sidebar" class="flex flex-col gap-2 max-h-[calc(100vh-2rem)] sticky top-4"></div>'}}).getElement(),R=(new class extends m{getTemplate(){return'<div id="search" class="flex flex-col w-full"><label for="search__control" class="text-sm font-bold">Search: </label></div>'}}).getElement(),L=(new class extends m{getTemplate(){return'<div id="language" class="flex flex-col w-full"><label for="language__control" class="text-sm font-bold">Language: </label></div>'}}).getElement(),F=(new class extends m{getTemplate(){return'<div id="source" class="flex flex-col w-full h-full"><label for="source__control" class="text-sm font-bold">Sources: </label></div>'}}).getElement(),T=(new class extends m{getTemplate(){return'<div id="article" class="flex flex-col max-w-screen-sm"></div>'}}).getElement(),A=new class extends m{getTemplate(){return'<select id="language__control" name="language"></select>'}},I=new class extends m{getTemplate(){return'<select name="source[]" multiple class="h-full"></select>'}},$=new class extends m{getTemplate(){return'<ol class="flex flex-col gap-4"></ol>'}},M=new class{constructor(e,t,s){this.container=e,this.viewFactory=t,this.model=s,this.handleInput=this.handleInput.bind(this)}init(){this.drawSearchInput()}drawSearchInput(){const e=this.viewFactory(this.model.search);d.render(this.container,e.getElement(),u.BEFORE_END),e.getElement().addEventListener("input",function(e,t){let s;return(...r)=>(s&&clearTimeout(s),new Promise((a=>{s=setTimeout((()=>{const t=e(...r);a(t)}),t)})))}(this.handleInput,300))}handleInput(e){this.model.search=e.target.value}}(R,(e=>new w(e)),v),D=new class{constructor(e,t,s,r){this.container=e,this.languageSelectView=t,this.viewFactory=s,this.model=r,this.select=this.languageSelectView.getElement(),this.select.addEventListener("change",this.handleSelect.bind(this))}get languageList(){return this.model.languages}init(){this.drawLanguageSelect(),this.drawLanguageSelectOptions()}drawLanguageSelect(){d.render(this.container,this.select,u.BEFORE_END)}drawLanguageSelectOptions(){this.languageList.forEach(((e,t)=>{const s=this.viewFactory(e);d.render(this.select,s.getElement(),u.BEFORE_END),e===this.model.language&&(this.select.selectedIndex=t)}))}handleSelect(){this.model.language=this.select.options[this.select.selectedIndex].value}}(L,A,(e=>new f(e)),_),N=new class{constructor(e,t,s,r,a){this.container=e,this.sourceSelectView=t,this.viewFactory=s,this.model=r,this.languageModel=a,this.select=this.sourceSelectView.getElement(),this.select.addEventListener("change",this.handleSelect.bind(this))}async init(){await this.fetchSources(),this.drawSourceSelect(),this.drawSourceSelectOptions(),this.languageModel.subscribe((()=>{this.fetchSources()})),this.model.subscribe((()=>{this.drawSourceSelectOptions()}))}fetchSources(){return this.model.fetchSources({language:this.languageModel.language})}drawSourceSelect(){d.render(this.container,this.select,u.BEFORE_END)}drawSourceSelectOptions(){this.select.innerHTML="",this.model.sources.forEach((e=>{const t=this.viewFactory(e);d.render(this.select,t.getElement(),u.BEFORE_END),this.model.selected.includes(e)&&t.getElement().setAttribute("selected","")}))}handleSelect(){const e=[].slice.call(this.select.selectedOptions).map((e=>e.value));this.model.selected=this.model.sources.filter((({id:t})=>e.includes(t)))}}(F,I,(e=>new E(e)),x,_),B=new class{constructor(e,t,s,r,a,i,n){this.container=e,this.articleListView=t,this.viewFactory=s,this.model=r,this.searchModel=a,this.languageModel=i,this.sourcesModel=n,this.list=this.articleListView.getElement(),this.handleIntersectionObserver=this.handleIntersectionObserver.bind(this),this.observer=new IntersectionObserver(this.handleIntersectionObserver)}async init(){await this.fetchArticles(),this.drawArticleList(),this.drawArticleListItems(),this.searchModel.subscribe((()=>{this.fetchArticles()})),this.languageModel.subscribe((()=>{this.fetchArticles()})),this.sourcesModel.subscribe((()=>{this.fetchArticles()})),this.model.subscribe((()=>{this.drawArticleListItems()}))}fetchArticles(){return this.model.fetchArticles({search:this.searchModel.search,language:this.languageModel.language,sources:this.sourcesModel.selected.map((e=>e.id)).join(",")})}drawArticleList(){d.render(this.container,this.list,u.BEFORE_END)}drawArticleListItems(){this.list.innerHTML="",this.model.articles.forEach(((e,t)=>{const s=this.viewFactory(e);d.render(this.list,s.getElement(),u.BEFORE_END),t===.9*this.model.articles.length&&this.drawSentinel()}))}drawSentinel(){const e=d.createElement('<div class="sentinel"/>');d.render(this.list,e,u.BEFORE_END),this.observer.observe(e)}handleIntersectionObserver(e,t){const s=e.find((e=>e.intersectionRatio));if(s)return t.unobserve(s.target),this.model.fetchMoreArticles({search:this.searchModel.search,language:this.languageModel.language,sources:this.sourcesModel.selected.map((e=>e.id)).join(",")})}}(T,$,(e=>new p(e)),S,v,_,x);M.init(),D.init(),N.init().then((()=>B.init())),d.render(document.body,O,u.BEFORE_END),d.render(document.body,y,u.BEFORE_END),d.render(O,R,u.BEFORE_END),d.render(O,L,u.BEFORE_END),d.render(O,F,u.BEFORE_END),d.render(y,T,u.AFTER_BEGIN);
